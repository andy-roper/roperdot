if [[ "$1" == "--help" || "$1" == "-h" || "$1" == "-?" ]]; then
	cat <<EOT
detect-os: determine what OS is being used
Usage: detect-os

This script will generate several environment variables to indicate what OS is
in use.

ROPERDOT_OS_TYPE           Type of OS: linux, mac or windows
ROPERDOT_OS_NAME           Name of the OS family, e.g. centos, centos-gnome,
                           darwin, debian, raspbian, rhel, ubuntu
ROPERDOT_OS_VERSION        Version of OS
ROPERDOT_OS_ENV            Name of the OS/environment, e.g. centos-gnome, darwin
                           debian, debian-gnome, kubuntu, msys, ubuntu
ROPERDOT_OS_CODENAME       Name of the distribution, e.g. bionic
ROPERDOT_OS_FAMILY         Linux distribution family. e.g. debian for Debian,
                           Mint, Ubuntu and Kubuntu
ROPERDOT_DESKTOP_ENV       Name of the desktop environment, e.g. gnome, kde, mac,
                           windows
ROPERDOT_DESKTOP_VERSION   Major desktop version
ROPERDOT_KERNEL_ARCH       Kernel architecture, 32 or 64
ROPERDOT_WSL               true if running in WSL
ROPERDOT_WSL_V1            true if using WSL v1
EOT
	exit 0
fi

# This won't work with the built-in sed on Macs because it's crap
# ROPERDOT_CURRENT_SHELL=$(ps -p $$ | tail -1 | sed -r -e 's/^.*:[0-9]{2}[^ ]* //;s/ .*//;s/^.*\///')

# Derive ROPERDOT_OS_NAME from /etc/os-release, XDG_CURRENT_DESKTOP, or uname
if [[ -f /etc/os-release ]]; then
	ROPERDOT_OS_TYPE=linux
	osname=$(grep '^ID=' /etc/os-release | cut -c 4- | tr -d '"')
	ROPERDOT_OS_VERSION=$(grep '^VERSION_ID=' /etc/os-release | cut -c 13- | head -c -2)
	ROPERDOT_OS_CODENAME=$(grep '^UBUNTU_CODENAME=' /etc/os-release | cut -c 17-)
	if [[ -f /proc/version ]] && grep -iq Microsoft /proc/version; then
		# Windows Subsystem for Linux (WSL)
		ROPERDOT_DESKTOP_ENV=windows
		/mnt/c/Windows/System32/net.exe session >/dev/null 2>&1 && HAS_ADMIN_RIGHTS=true
		wsl.exe --list --verbose | grep -Pa 'U\x00s\x00a\x00g\x00e' >/dev/null && ROPERDOT_WSL_V1=true
	fi
	case "$osname" in
		ubuntu)
			ROPERDOT_OS_NAME=ubuntu
			ROPERDOT_OS_FAMILY=debian
			if [[ "$XDG_CURRENT_DESKTOP" =~ KDE ]]; then
				ROPERDOT_OS_ENV=kubuntu
				ROPERDOT_DESKTOP_ENV=kde
			elif [[ "$XDG_CURRENT_DESKTOP" =~ GNOME ]]; then
				ROPERDOT_OS_ENV=ubuntu
				ROPERDOT_DESKTOP_ENV=gnome
			else
				ROPERDOT_OS_ENV=ubuntu
			fi
			;;
		debian)
			# TODO Add detection of Debian desktop environments
			ROPERDOT_OS_NAME=debian
			ROPERDOT_OS_FAMILY=debian
			ROPERDOT_OS_ENV=debian
			;;
		centos)
			ROPERDOT_OS_NAME=$osname
			ROPERDOT_OS_FAMILY=rhel
			if [[ "$XDG_CURRENT_DESKTOP" =~ GNOME ]]; then
				ROPERDOT_OS_ENV=$osname-gnome
				ROPERDOT_DESKTOP_ENV=gnome
			else
				ROPERDOT_OS_ENV=$osname
			fi
			;;
		linuxmint)
			ROPERDOT_OS_NAME=$osname
			ROPERDOT_OS_ENV=mint
			ROPERDOT_OS_FAMILY=debian
			[[ -n "$XDG_CURRENT_DESKTOP" ]] && ROPERDOT_DESKTOP_ENV=gnome
			;;
		*)
			# rhel, raspbian
			ROPERDOT_OS_NAME=$osname
			ROPERDOT_OS_ENV=$osname
			ROPERDOT_OS_FAMILY=$osname
			;;
	esac
else
	if [[ "$OSTYPE" = "msys" ]]; then
		ROPERDOT_OS_TYPE=windows
		ROPERDOT_OS_NAME=ubuntu
		ROPERDOT_OS_FAMILY=debian
		ROPERDOT_OS_ENV=msys
		ROPERDOT_DESKTOP_ENV=windows
		# ROPERDOT_OS_VERSION=$(systeminfo | grep '^OS Version:' | awk '{print $3}')
		verstr=$(wmic os get caption) && ROPERDOT_OS_VERSION=$(echo "$verstr" | awk '{print $5}')
	else
		# Darwin
		uname=$(uname)
		if [[ "$uname" = "Darwin" ]]; then
			ROPERDOT_OS_TYPE=mac
			ROPERDOT_OS_NAME=darwin
			ROPERDOT_OS_ENV=darwin
			ROPERDOT_OS_FAMILY=darwin
			ROPERDOT_DESKTOP_ENV=mac
			ROPERDOT_OS_VERSION=$(sw_vers | grep "^ProductVersion" | awk '{print $2}')
		fi
	fi
	if [[ "$ROPERDOT_OS_TYPE" = "windows" ]]; then
		net session >/dev/null 2>&1 && HAS_ADMIN_RIGHTS=true
	fi
fi

if [[ "$(uname -m)" = "x86_64" ]]; then
	ROPERDOT_KERNEL_ARCH=64
else
	ROPERDOT_KERNEL_ARCH=32
fi

if [[ "$ROPERDOT_DESKTOP_ENV" = "windows" ]]; then
	ROPERDOT_DESKTOP_VERSION="$(/mnt/c/Windows/System32/wbem/wmic.exe os get caption | tail -2 | head -1 | sed -E 's/^Microsoft Windows ([[:digit:]]+).*/\1/')"
fi

export ROPERDOT_OS_TYPE ROPERDOT_OS_NAME ROPERDOT_OS_VERSION ROPERDOT_OS_ENV ROPERDOT_OS_CODENAME ROPERDOT_OS_FAMILY ROPERDOT_DESKTOP_ENV ROPERDOT_DESKTOP_VERSION ROPERDOT_KERNEL_ARCH ROPERDOT_WSL ROPERDOT_WSL_V1 HAS_ADMIN_RIGHTS
