#
# Description: Install script for Visual Studio Code
#
# Author: Andy Roper <andyroper42@gmail.com>
# URL: https://github.com/andy-roper/roperdot
#

. "${ROPERDOT_DIR}/source-scripts/input-functions"
. "${ROPERDOT_DIR}/source-scripts/install-script-functions"

if [[ "$ROPERDOT_DESKTOP_ENV" = "windows" ]]; then
	choco install -y --ignore-pending-reboot vscode
	. "${ROPERDOT_DIR}/source-scripts/win-env-functions"
	def_win_env_linux_path ProgramFiles
	[[ -d "${ProgramFiles}/Microsoft VS Code" ]] || exit 0
elif [[ "$ROPERDOT_OS_TYPE" = "linux" ]]; then
	if command -v snap >/dev/null 2>&1; then
		sudo systemctl restart snapd  # restart snapd in case certificates have changed
		sudo snap install --classic code
	else
		# Clean up old VS Code repository configurations to prevent conflicts
		echo "Cleaning up old VS Code repository configurations..."
		sudo rm -f /etc/apt/sources.list.d/vscode.list*
		sudo rm -f /etc/apt/keyrings/packages.microsoft.gpg
		sudo rm -f /usr/share/keyrings/microsoft.gpg
		
		# Install prerequisites
		sudo apt-get update
		sudo apt-get install -y apt-transport-https ca-certificates curl gnupg
		
		echo "Adding VS Code GPG key and repository..."
		curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor | sudo tee /usr/share/keyrings/microsoft.gpg > /dev/null
		echo "deb [arch=amd64,arm64,armhf signed-by=/usr/share/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/code stable main" | \
			sudo tee /etc/apt/sources.list.d/vscode.list > /dev/null
		
		# Update package lists and install VS Code
		sudo apt-get update
		sudo apt-get install -y code
	fi
elif [[ "$ROPERDOT_OS_ENV" = "darwin" ]]; then
	if [[ -n "$has_sudo" ]]; then
		brew install visual-studio-code
	else
		brew install visual-studio-code --appdir=~/Applications
	fi
fi

if [[ "$ROPERDOT_DESKTOP_ENV" == windows ]]; then
	if ! command -v code >/dev/null 2>&1; then
		code () { "${ProgramFiles}/Microsoft VS Code/bin/code" "$@"; }
	fi
else
	if command -v code >/dev/null 2>&1; then
		local code_bin=$(command -v code)
		code () { "$code_bin" "$@"; }
	else
		exit 0
	fi
fi

if [[ "$ROPERDOT_DESKTOP_ENV" = "windows" ]]; then
	selection="$(select_from_list_index "Apply updates to VS Code settings install recommended extensions for" 3 "VS Code for Windows" "VS Code for WSL" "Both")"
	case "$selection" in
		1) export regular_install=true ;;
		2) export windows_install=true ;;
		3) export regular_install=true windows_install=true ;;
	esac
else
	export regular_install=true
fi

install_ext () {
	if [[ -n "$regular_install" ]]; then
		if [[ "$ROPERDOT_DESKTOP_ENV" = "windows" ]]; then
			if [[ ! -d ~/.vscode-server/"$1" ]]; then
				if ! code --install-extension "$1" --force; then
					echo "DNS issue encountered while installing VSCode extension"
					
					# Handle /etc/wsl.conf backup and update
					if [[ ! -f /etc/wsl.conf.bak ]]; then
						echo "Backing up /etc/wsl.conf"
						sudo cp /etc/wsl.conf /etc/wsl.conf.bak 2>/dev/null || sudo touch /etc/wsl.conf.bak
					fi
					
					# Update wsl.conf - check if [network] section exists
					if ! sudo grep -q '^\[network\]' /etc/wsl.conf 2>/dev/null; then
						echo "Adding [network] section to /etc/wsl.conf"
						echo -e "\n[network]\ngenerateResolvConf = false" | sudo tee -a /etc/wsl.conf > /dev/null
					elif ! sudo grep -q '^generateResolvConf' /etc/wsl.conf 2>/dev/null; then
						echo "Adding generateResolvConf to [network] section"
						sudo sed -i '/^\[network\]/a generateResolvConf = false' /etc/wsl.conf
					else
						echo "Updating generateResolvConf setting"
						sudo sed -i 's/^generateResolvConf.*/generateResolvConf = false/' /etc/wsl.conf
					fi
					
					# Handle /etc/resolv.conf - preserve if it's a symlink
					if [[ -L /etc/resolv.conf ]]; then
						echo "/etc/resolv.conf is a symlink, unlinking it"
						sudo unlink /etc/resolv.conf
					fi
					
					if [[ -f /etc/resolv.conf && ! -f /etc/resolv.conf.bak ]]; then
						echo "Backing up /etc/resolv.conf"
						sudo cp /etc/resolv.conf /etc/resolv.conf.bak
					fi
					
					# Create new resolv.conf with DNS servers
					echo "Updating /etc/resolv.conf with custom DNS servers"
					sudo tee /etc/resolv.conf > /dev/null << EOT
nameserver 8.8.8.8
nameserver 1.1.1.1
nameserver 10.255.255.254
search mshome.net
EOT
					
					echo "DNS fix applied, retrying extension install..."
					code --install-extension "$1" --force
				fi
			fi
		else
			[[ -d ~/.vscode/"$1" ]] || code --install-extension "$1" --force
		fi
	fi
	# ... rest of function
}

if command -v choco >/dev/null 2>&1; then
	choco list --local-only >/dev/null && have_shellcheck=true
elif [[ "$ROPERDOT_OS_ENV" = "darwin" ]] && command -v brew >/dev/null 2>&1; then
	brew list >/dev/null && have_shellcheck=true
elif command -v apt >/dev/null 2>&1; then
	apt list --installed >/dev/null && have_shellcheck=true
fi

# skipping_extension_installs=true
if [[ -z $skipping_extension_installs ]]; then
	export NODE_EXTRA_CA_CERTS=/etc/ssl/certs/ca-certificates.crt

	[[ "$ROPERDOT_OS_TYPE" = "linux" && "$ROPERDOT_DESKTOP_ENV" = "windows" ]] && install_ext ms-vscode-remote.remote-wsl
	[[ -n "$have_shellcheck" ]] && install_ext timonwong.shellcheck
	if [[ ",$install_groups," != *,java-dev,* ]]; then
		install_ext wallabyjs.quokka-vscode
		install_ext dbaeumer.vscode-eslint
		install_ext dbaeumer.jshint
		install_ext christian-kohler.path-intellisense
		install_ext redhat.vscode-server-connector
		install_ext redhat.vscode-community-server-connector
	fi
	if [[ ",$install_groups," == *,aws,* ]]; then
		install_ext amazonwebservices.aws-toolkit-vscode
		install_ext aws-scripting-guy.cform
	fi
	install_ext albymor.increment-selection
	install_ext redhat.vscode-yaml
	install_ext atlassian.atlascode
	install_ext ms-azuretools.vscode-docker
	install_ext ms-vscode-remote.remote-containers
	# install_ext msjsdiag.debugger-for-chrome
	install_ext donjayamanne.githistory
	install_ext eamodio.gitlens
	install_ext github.copilot
	# install_ext github.copilot-chat  # Commented on 11/28/25 due to crash when installing
	install_ext ms-azuretools.vscode-containers
	install_ext yzhang.markdown-all-in-one
	install_ext ms-vscode.hexeditor

	# install_ext oracle.sql-developer
	# install_ext mycelo.oracle-plsql
	# install_ext mp.vscode-oracle-format
	# install_ext ms-python.python
	# install_ext ms-vscode.vscode-typescript-next
	# install_ext esbenp.prettier-vscode
	# install_ext ms-vscode.vscode-json
	# install_ext ms-vscode-remote.remote-ssh
	# install_ext ms-vscode.remote-explorer
	# install_ext pkief.material-icon-theme
	# install_ext formulahendry.auto-rename-tag

	install_ext redhat.java
	install_ext vscjava.vscode-java-pack
	install_ext vscjava.vscode-java-debug
	install_ext vscjava.vscode-java-test
	install_ext vscjava.vscode-maven
	install_ext redhat.vscode-xml
fi

export color_scheme

update-vscode-settings || echo "Visual Studio Code settings.json could not be updated. You should run update-vscode-settings after starting Visual Studio Code so it can create the application's user directory."
