#
# Description: Install script for jq
#
# Author: Andy Roper <andyroper42@gmail.com>
# URL: https://github.com/andy-roper/roperdot
#

#DEBUGGING=true
#. "${ROPERDOT_DIR}/source-scripts/debug"
#debug start

. "${ROPERDOT_DIR}/source-scripts/nice-copy"

if [[ -z "$has_sudo" ]]; then
	echo "User lacks sudo access; aborting install of jq"
	exit 1
elif [[ "$ROPERDOT_OS_ENV" = "darwin" ]]; then
	if command -v brew >/dev/null 2>&1; then
		brew install jq
	elif [[ -d "$INSTALLSOURCE" ]]; then
		manual_install=true
		dir="$(find "$INSTALLSOURCE" -maxdepth 1 -type d -name "jq*")"
		if [[ -d "$dir" ]]; then
			cd "$dir" || return 1
			if [[ -e jq-osx-amd64 ]]; then
				nice_copy jq-osx-amd64 "${ROPERDOT_DIR}/extra-bin/jq"
				installed=true
			fi
		fi
	else
		echo "brew not available and binary not found in INSTALLSOURCE; aborting jq install"
	fi
elif command -v apt >/dev/null 2>&1; then
	sudo apt install jq -y
	# Added the line below because the jq installation was spuriously exiting with
	# an error every time even though it completed normally
	exit 0
elif command -v yum >/dev/null 2>&1; then
	sudo yum install jq -y
fi
# echo "Performing final check"
if [[ -n "$manual_install" ]]; then
	if [[ -n "$installed" ]]; then
		copy_man_pages jq.1.gz
	else
		echo "binary not found in INSTALLSOURCE; aborting jq install"
	fi
fi
# echo "End of install-jq"
