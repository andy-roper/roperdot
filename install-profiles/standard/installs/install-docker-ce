#
# Description: Install script for Docker CE (official Docker)
#
# Author: Andy Roper <andyroper42@gmail.com>
# URL: https://github.com/andy-roper/roperdot
#

source "${ROPERDOT_DIR}/source-scripts/install-script-functions"

if [[ "$ROPERDOT_OS_FAMILY" = debian && "$ROPERDOT_DESKTOP_ENV" != windows ]]; then
    echo "Installing Docker CE..."

    # Install prerequisites
    sudo apt-get update
    sudo apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release

    # Add Docker's official GPG key
    sudo install -m 0755 -d /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    sudo chmod a+r /etc/apt/keyrings/docker.gpg

    # Set up the Docker repository
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | \
     sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

    # Install Docker CE
    sudo apt-get update
    sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

    # Add current user to docker group
    if ! groups | grep -q docker; then
        sudo groupadd docker 2>/dev/null || true
        sudo usermod -aG docker "$USER"
        echo ""
        echo "=========================================="
        echo "Docker CE installed successfully!"
        echo ""
        echo "IMPORTANT: You have been added to the 'docker' group."
        echo "You must LOG OUT and LOG BACK IN for this to take effect."
        echo "Until then, you'll need to use 'sudo docker' to run Docker commands."
        echo "=========================================="
        echo ""
    else
        echo "Docker CE installed successfully!"
    fi
fi
