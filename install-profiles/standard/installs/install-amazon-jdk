#
# Description: Install script for Amazon Corretto JDK
#
# Author: Andy Roper <andyroper42@gmail.com>
# URL: https://github.com/andy-roper/roperdot
#

SDK_VERSION=21
AMZN_VERSION=21.0.9-amzn

source "${ROPERDOT_DIR}/source-scripts/install-script-functions"

# Ensure SDKMAN is available
if [[ ! -d ~/.sdkman ]]; then
	echo "Error: SDKMAN is not installed. Please install SDKMAN first."
	exit 1
fi

# Source SDKMAN (disable exit-on-error temporarily in case init script has non-zero exit)
export SDKMAN_DIR="$HOME/.sdkman"
[[ -s "$SDKMAN_DIR/bin/sdkman-init.sh" ]] && { source "$SDKMAN_DIR/bin/sdkman-init.sh" || true; }

# Verify sdk command is available
if ! type sdk &>/dev/null; then
    echo "Error: sdk command not available after sourcing sdkman-init.sh"
    exit 1
fi

# Find the latest Amazon Corretto version for the specified major version
# echo "Finding latest Amazon Corretto ${SDK_VERSION}..."
# AMZN_VERSION=$(sdk list java | grep -E "^\s+${SDK_VERSION}\.[0-9.]+-amzn" | head -1 | awk '{print $NF}')

# if [[ -z "$AMZN_VERSION" ]]; then
#     echo "Error: Could not find Amazon Corretto ${SDK_VERSION} in SDKMAN"
#     echo "Available versions:"
#     sdk list java | grep amzn
#     exit 1
# fi

# echo "Found Amazon Corretto version: ${AMZN_VERSION}"

# Check if already installed
if sdk list java | grep -q "${AMZN_VERSION}.*installed"; then
    echo "Amazon Corretto JDK ${AMZN_VERSION} is already installed"
    exit 0
fi

# Install Amazon Corretto JDK
echo "Installing Amazon Corretto JDK ${AMZN_VERSION}..."
# Use < /dev/null to prevent interactive prompts
if ! sdk install java ${AMZN_VERSION}; then
    echo "Error: Failed to install Amazon Corretto JDK"
    exit 1
fi

# Set as default Java version
sdk default java ${AMZN_VERSION}

echo "Amazon Corretto JDK ${AMZN_VERSION} installed successfully"
