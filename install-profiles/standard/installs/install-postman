#
# Description: Install script for Postman
#
# Author: Andy Roper <andyroper42@gmail.com>
# URL: https://github.com/andy-roper/roperdot
#

# Last updated for current version on 15 Aug 2025

. "${ROPERDOT_DIR}/source-scripts/install-script-functions"

# https://www.getpostman.com/apps

if [[ "$ROPERDOT_OS_FAMILY" = debian && "$ROPERDOT_DESKTOP_ENV" = gnome ]]; then
	temp_dir="$(mktemp -d)"
	pushd "$temp_dir" >/dev/null || exit 1
	
	echo "Downloading Postman from https://dl.pstmn.io/download/latest/linux64"
	
	# Download with visible output for debugging
	if command -v wget >/dev/null 2>&1; then
		wget --no-check-certificate --max-redirect=10 -O postman.tar.gz https://dl.pstmn.io/download/latest/linux64
	elif command -v curl >/dev/null 2>&1; then
		curl -L --insecure -o postman.tar.gz https://dl.pstmn.io/download/latest/linux64
	else
		echo "Neither wget nor curl found"
		exit 1
	fi
	
	# Check if download succeeded
	if [[ ! -f postman.tar.gz || ! -s postman.tar.gz ]]; then
		echo "Failed to download Postman - file is missing or empty"
		popd >/dev/null
		rm -rf "$temp_dir"
		exit 1
	fi
	
	# Verify the downloaded file is a valid gzip file
	echo "Verifying downloaded archive..."
	if ! gzip -t postman.tar.gz 2>&1; then
		echo "Downloaded file is not a valid gzip archive"
		echo "File size: $(ls -lh postman.tar.gz)"
		echo "First few bytes:"
		head -c 100 postman.tar.gz | od -c
		popd >/dev/null
		rm -rf "$temp_dir"
		exit 1
	fi
	
	echo "Extracting Postman..."
	sudo tar -xzf postman.tar.gz -C /opt
	rm postman.tar.gz
	ln -s /opt/Postman/app/Postman "${ROPERDOT_DIR}/extra-bin/postman"
	[[ -d "$HOME/.local/share/icons" ]] || mkdir -p "$HOME/.local/share/icons"
	cp /opt/Postman/app/resources/app/assets/icon.png "$HOME/.local/share/icons/postman.png"
	[[ -d "$HOME/.local/share/applications" ]] || mkdir -p "$HOME/.local/share/applications"
	cat << EOT > "$HOME/.local/share/applications/postman.desktop"
[Desktop Entry]
Encoding=UTF-8
Version=11.58.4
Name=Postman
Type=Application
Exec=/opt/Postman/app/Postman
Icon=postman.png
Terminal=false
Categories=Application;Development;Programming;Internet;Network
EOT
	popd >/dev/null || exit 1
	rm -rf "$temp_dir" >/dev/null
	
	echo "Postman installation complete"
fi