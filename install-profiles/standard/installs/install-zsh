#
# Description: Install script for zsh
#
# Author: Andy Roper <andyroper42@gmail.com>
# URL: https://github.com/andy-roper/roperdot
#

. "${ROPERDOT_DIR}/source-scripts/input-functions"
. "${ROPERDOT_DIR}/source-scripts/update-config-files"

if [[ -z "$PACKAGE_MANAGER" ]]; then
	echo "Package manager not found; cannot install zsh"
elif [[ "$PACKAGE_MANAGER" = brew ]]; then
	export HOMEBREW_CURLRC=1
	brew install zsh
elif [[ "$PACKAGE_MANAGER" = apt-get || "$PACKAGE_MANAGER" = yum ]]; then
	sudo "$PACKAGE_MANAGER" -y install zsh
fi
if command -v zsh >/dev/null 2>&1; then
	if [[ -e ~/.zshrc ]]; then
		if [[ -e ~/.zshrc.pre-roperdot ]]; then
			echo "Moving ~/.zshrc to ~/.zshrc.bak"
			mv ~/.zshrc ~/.zshrc.bak
		else
			echo "Moving ~/.zshrc to ~/.zshrc.pre-roperdot"
			mv ~/.zshrc ~/.zshrc.pre-roperdot
		fi
	fi
	echo "Creating ~/.zshrc"
	cat << EOT > ~/.zshrc
autoload -Uz compinit && compinit -i
bindkey "\e[3~" delete-char
bindkey "^[[H"  beginning-of-line
bindkey "^[[F"  end-of-line
EOT
	add_package_sourcing .zshrc
	if ! command -v starship >/dev/null 2>&1; then
		ROPERDOT_CURRENT_SHELL=zsh zsh "${ROPERDOT_DIR}/install-profiles/standard/installs/install-starship"
		command -v starship >/dev/null 2>&1 || echo "export PROMPT=\"%~ %# \"" >> .zshrc
	fi
	if [[ "$ROPERDOT_OS_ENV" = darwin ]]; then
		ZSHPATH=$(brew --prefix)/bin/zsh
		# [[ "$ROPERDOT_CURRENT_SHELL" = zsh ]] && default_value=y || default_value=n
		default_value=y
		if ask_yn_n "Make the new zsh version the default shell" $default_value; then
			echo Setting "$ZSHPATH" as the default shell
			if ! grep "$ZSHPATH" /etc/shells >/dev/null; then
				if [[ -n "$has_sudo" ]]; then
					echo "Adding $ZSHPATH to /etc/shells"
					echo "$ZSHPATH" | sudo tee -a /etc/shells >/dev/null
					chsh -s "$ZSHPATH"
				else
			        echo "$ZSHPATH is not in /etc/shells"
			        echo "To use it as your default shell, run:"
			        echo "  echo '$ZSHPATH' | sudo tee -a /etc/shells"
			        echo "  chsh -s '$ZSHPATH'"
				fi
			fi
			echo "You should close the terminal window and open a new one after the install to use the new zsh version."
		fi
	fi
fi