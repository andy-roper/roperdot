#
# Description: Install script for Sublime Text
#
# Author: Andy Roper <andyroper42@gmail.com>
# URL: https://github.com/andy-roper/roperdot
#

. "${ROPERDOT_DIR}/source-scripts/install-script-functions"
. "${ROPERDOT_DIR}/source-scripts/win-path-functions"

export warning_text=$(echo -e '\x1B[0;91m')
export normal_text=$(echo -e '\x1B[0m')

if [[ "$ROPERDOT_OS_ENV" = darwin ]]; then
	if [[ -n "$has_sudo" ]]; then
		brew install sublime-text || exit $?
	else
		brew install sublime-text --appdir=~/Applications || exit $?
	fi
	sublime_text_dir="$HOME/Library/Application Support/Sublime Text"
elif [[ "$ROPERDOT_DESKTOP_ENV" = windows ]]; then
	choco install -y --ignore-pending-reboot sublimetext4 || exit $?
	source "${ROPERDOT_DIR}/source-scripts/win-env-functions"
	sublime_text_dir="$(win_env_linux_path APPDATA)/Sublime Text"
	[[ "$(desktop_shortcut_exists "Sublime Text")" ]] || create-windows-shortcut "Sublime Text" "%PROGRAMFILES%\Sublime Text\sublime_text.exe"
elif [[ "$ROPERDOT_OS_FAMILY" = debian && "$ROPERDOT_DESKTOP_ENV" = gnome ]]; then
	print-web-file https://download.sublimetext.com/sublimehq-pub.gpg | sudo apt-key add - || exit $?
	echo "deb https://download.sublimetext.com/ apt/stable/" | sudo tee /etc/apt/sources.list.d/sublime-text.list || exit $?
	sudo apt update || exit $?
	sudo apt install sublime-text -y || exit $?
	sublime_text_dir="$HOME/.config/sublime-text"
else
	echo "Unsupported platform"
	exit 1
fi

sublime_user_dir="${sublime_text_dir}/Packages/User"
[[ -d "$sublime_user_dir" ]] || mkdir -p "$sublime_user_dir"
config_files="${ROPERDOT_DIR}/install-profiles/standard/config-files/sublime-text"

if [[ -d "$sublime_user_dir" ]]; then
	source "${ROPERDOT_DIR}/source-scripts/input-functions"
	ask_yn_n "Apply updates to Sublime Text user preferences and install recommended packages" y || exit 0
else
	mkdir -p "$sublime_user_dir"
fi

. "${ROPERDOT_DIR}/source-scripts/find-pip"

# Set values in $sublime_user_dir/Preferences.sublime-settings
if [[ -f "$sublime_user_dir/Preferences.sublime-settings" ]]; then
	echo "Backing up $config_files/Preferences.sublime-settings to $config_files/Preferences.sublime-settings.bak"
	cp "$config_files/Preferences.sublime-settings" "$config_files/Preferences.sublime-settings.bak"
#	$python_bin "$ROPERDOT_DIR/bin/set-values-in-json" "$sublime_user_dir/Preferences.sublime-settings" @"$config_files/Preferences.sublime-settings" || { echo "first set-values-in-json failed with exit code $?, continuing to debug..."; }
	$python_bin "$ROPERDOT_DIR/bin/set-values-in-json" "$sublime_user_dir/Preferences.sublime-settings" @"$config_files/Preferences.sublime-settings"
else
	cp "$config_files/Preferences.sublime-settings" "$sublime_user_dir"
fi

# Copy schemes
cp "$config_files/"*.sublime-color-scheme "$sublime_user_dir"

if [[ ! -f "$sublime_text_dir/Installed Packages/Package Control.sublime-package" ]]; then
	[[ -d "$sublime_text_dir/Installed Packages" ]] || mkdir -p "$sublime_text_dir/Installed Packages"
	get-web-file "https://packagecontrol.io/Package%20Control.sublime-package" "$sublime_text_dir/Installed Packages/Package Control.sublime-package"
fi

# Detect Zscaler MITM proxy in ca-certificates
if [[ -f /etc/ssl/certs/ca-certificates.crt ]]; then
	if awk -v cmd='openssl x509 -noout -subject' '/BEGIN/{close(cmd)};{print | cmd}' < /etc/ssl/certs/ca-certificates.crt 2>/dev/null | grep -qi zscaler; then
		echo "Zscaler detected: packages will be directly downloaded to bypass SSL issues"
		zscaler_detected=true
	fi
fi

# If Zscaler detected, download packages directly to Packages directory
if [[ -n "$zscaler_detected" ]]; then
	packages_dir="${sublime_text_dir}/Packages"
	[[ -d "$packages_dir" ]] || mkdir -p "$packages_dir"
	
	# Define package repositories (GitHub URLs for direct download)
	declare -A package_repos=(
		["Alignment"]="https://github.com/wbond/sublime_alignment/archive/refs/heads/master.zip"
		["BracketHighlighter"]="https://github.com/facelessuser/BracketHighlighter/archive/refs/heads/master.zip"
		["Column Select"]="https://github.com/ehuss/Sublime-Column-Select/archive/refs/heads/master.zip"
		["Emmet"]="https://github.com/emmetio/sublime-text-plugin/archive/refs/heads/master.zip"
		["HexViewer"]="https://github.com/facelessuser/HexViewer/archive/refs/heads/master.zip"
		["HTML-CSS-JS Prettify"]="https://github.com/victorporof/Sublime-HTMLPrettify/archive/refs/heads/master.zip"
		["HTML5"]="https://github.com/mrmartineau/HTML5/archive/refs/heads/master.zip"
		["IndentX"]="https://github.com/socsieng/IndentX/archive/refs/heads/master.zip"
		["Pretty JSON"]="https://github.com/dzhibas/SublimePrettyJson/archive/refs/heads/master.zip"
		["SideBarEnhancements"]="https://github.com/titoBouzout/SideBarEnhancements/archive/refs/heads/st3.zip"
		["Solarized Color Scheme"]="https://github.com/braver/Solarized/archive/refs/heads/master.zip"
		["SublimeCodeIntel"]="https://github.com/SublimeCodeIntel/SublimeCodeIntel/archive/refs/heads/master.zip"
		["SublimeLinter"]="https://github.com/SublimeLinter/SublimeLinter/archive/refs/heads/master.zip"
		["Terminal"]="https://github.com/wbond/sublime_terminal/archive/refs/heads/master.zip"
	)
	
	for package_name in "${!package_repos[@]}"; do
		package_dir="${packages_dir}/${package_name}"
		if [[ ! -d "$package_dir" ]]; then
			echo "Downloading ${package_name}..."
			zip_file="/tmp/${package_name}.zip"
			get-web-file "${package_repos[$package_name]}" "$zip_file"
			if [[ -f "$zip_file" ]]; then
				unzip -q "$zip_file" -d "/tmp/${package_name}_extract"
				# Move the extracted directory (handles master/st3 suffix)
				extracted_dir=$(find "/tmp/${package_name}_extract" -maxdepth 1 -type d -not -path "/tmp/${package_name}_extract")
				if [[ -d "$extracted_dir" ]]; then
					mv "$extracted_dir" "$package_dir"
					echo "Installed ${package_name}"
				fi
				rm -rf "$zip_file" "/tmp/${package_name}_extract"
			fi
		fi
	done
else
	if command -v choco >/dev/null 2>&1; then
		choco list --local-only >/dev/null && have_shellcheck=true
	elif [[ "$ROPERDOT_OS_ENV" = "darwin" ]] && command -v brew >/dev/null 2>&1; then
		brew list >/dev/null && have_shellcheck=true
	elif command -v apt >/dev/null 2>&1; then
		apt list --installed >/dev/null && have_shellcheck=true
	fi

	if [[ -f "$sublime_user_dir/Package Control.sublime-settings" ]]; then
		echo "Backing up $sublime_user_dir/Package Control.sublime-settings to $sublime_user_dir/Package Control.sublime-settings.bak"
		cp "$sublime_user_dir/Package Control.sublime-settings" "$sublime_user_dir/Package Control.sublime-settings.bak"
		
		if [[ "$zscaler_detected" != true ]]; then
			$python_bin "$ROPERDOT_DIR/bin/set-values-in-json" "$sublime_user_dir/Package Control.sublime-settings" bootstrapped true
			$python_bin "$ROPERDOT_DIR/bin/set-values-in-json" "$sublime_user_dir/Package Control.sublime-settings" --add-to-array installed_packages Alignment BracketHighlighter "Column Select" Emmet HexViewer "HTML-CSS-JS Prettify" HTML5 IndentX "Pretty JSON" SideBarEnhancements "Solarized Color Scheme" SublimeCodeIntel SublimeLinter Terminal
		else
			echo "Skipping Package Control bootstrapped setting due to Zscaler - packages downloaded directly"
		fi
	else
		cp "$config_files/Package Control.sublime-settings" "$sublime_user_dir"
	fi

	# [[ -n "$have_shellcheck" ]] && $python_bin "$ROPERDOT_DIR/bin/set-values-in-json" "$sublime_user_dir/Package Control.sublime-settings" --add-to-array installed_packages SublimeLinter-shellcheck || { echo "third set-values-in-json failed with exit code $?, continuing to debug..."; }
fi

if [[ "$ROPERDOT_DESKTOP_ENV" = windows ]]; then
	sublimetext_win_dir="$(win_env PROGRAMFILES)\\Sublime Text"
	sublimetext_exe="$sublimetext_win_dir\\subl.exe"

	echo -e "\nLaunching Sublime Text to generate initial configuration files..."
	echo "${warning_text}Sublime Text will open automatically. Close the application after the package dialogs finish spawning to continue the installation.${normal_text}"
	powershell.exe -Command "Start-Process -FilePath '$sublimetext_exe' -Wait"
    
    # Update HTMLPrettify settings
    settings_dir="${sublime_text_dir}/Packages/HTML-CSS-JS Prettify"
    htmlprettify_settings="${settings_dir}/HTMLPrettify.sublime-settings"
    if [[ -f "$htmlprettify_settings" ]]; then
        node_windows_path="$(where.exe node.exe)"
        node_windows_path="${node_windows_path//\\//}"
        $python_bin "$ROPERDOT_DIR/bin/set-values-in-json" \
            "$htmlprettify_settings" \
            node_path.windows "$node_windows_path"
    fi
fi

# Copy file with Pretty JSON context menu definition
cp "$config_files/Context.sublime-menu" "$sublime_user_dir"

# Set terminal spawned by Terminal package to iTerm 2
if [[ "$ROPERDOT_OS_ENV" = darwin && -d "/Applications/iTerm.app" ]]; then
	if [[ -f "$sublime_text_dir/Terminal/Terminal.sublime-settings" ]]; then
		echo "Backing up $sublime_user_dir/Terminal/Terminal.sublime-settings"
		cp "$sublime_user_dir/Terminal/Terminal.sublime-settings" "$sublime_user_dir/Terminal/Terminal.sublime-settings.bak"
#		$python_bin "$ROPERDOT_DIR/bin/set-values-in-json" "$sublime_user_dir/Terminal/Terminal.sublime-settings" terminal "iTerm2-v3.sh" || { echo "fourth set-values-in-json failed with exit code $?, continuing to debug..."; }
		$python_bin "$ROPERDOT_DIR/bin/set-values-in-json" "$sublime_user_dir/Terminal/Terminal.sublime-settings" terminal "iTerm2-v3.sh"
	else
		[[ -d "$sublime_text_dir/Terminal" ]] || mkdir "$sublime_text_dir/Terminal"
		cp "$config_files/Terminal.sublime-settings" "$sublime_text_dir/Terminal"
	fi
fi
